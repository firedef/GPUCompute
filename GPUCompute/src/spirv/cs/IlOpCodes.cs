using System.Reflection.Emit;

namespace GPUCompute.spirv.cs;

public static class IlOpCodes {
    public static readonly OpCode[] oneByteOps = new OpCode[256];
    public static readonly OpCode[] twoByteOps = new OpCode[256];

    static IlOpCodes() {
        oneByteOps[0] = OpCodes.Nop;
        oneByteOps[1] = OpCodes.Break;
        oneByteOps[2] = OpCodes.Ldarg_0;
        oneByteOps[3] = OpCodes.Ldarg_1;
        oneByteOps[4] = OpCodes.Ldarg_2;
        oneByteOps[5] = OpCodes.Ldarg_3;
        oneByteOps[6] = OpCodes.Ldloc_0;
        oneByteOps[7] = OpCodes.Ldloc_1;
        oneByteOps[8] = OpCodes.Ldloc_2;
        oneByteOps[9] = OpCodes.Ldloc_3;
        oneByteOps[10] = OpCodes.Stloc_0;
        oneByteOps[11] = OpCodes.Stloc_1;
        oneByteOps[12] = OpCodes.Stloc_2;
        oneByteOps[13] = OpCodes.Stloc_3;
        oneByteOps[14] = OpCodes.Ldarg_S;
        oneByteOps[15] = OpCodes.Ldarga_S;
        oneByteOps[16] = OpCodes.Starg_S;
        oneByteOps[17] = OpCodes.Ldloc_S;
        oneByteOps[18] = OpCodes.Ldloca_S;
        oneByteOps[19] = OpCodes.Stloc_S;
        oneByteOps[20] = OpCodes.Ldnull;
        oneByteOps[21] = OpCodes.Ldc_I4_M1;
        oneByteOps[22] = OpCodes.Ldc_I4_0;
        oneByteOps[23] = OpCodes.Ldc_I4_1;
        oneByteOps[24] = OpCodes.Ldc_I4_2;
        oneByteOps[25] = OpCodes.Ldc_I4_3;
        oneByteOps[26] = OpCodes.Ldc_I4_4;
        oneByteOps[27] = OpCodes.Ldc_I4_5;
        oneByteOps[28] = OpCodes.Ldc_I4_6;
        oneByteOps[29] = OpCodes.Ldc_I4_7;
        oneByteOps[30] = OpCodes.Ldc_I4_8;
        oneByteOps[31] = OpCodes.Ldc_I4_S;
        oneByteOps[32] = OpCodes.Ldc_I4;
        oneByteOps[33] = OpCodes.Ldc_I8;
        oneByteOps[34] = OpCodes.Ldc_R4;
        oneByteOps[35] = OpCodes.Ldc_R8;
        oneByteOps[37] = OpCodes.Dup;
        oneByteOps[38] = OpCodes.Pop;
        oneByteOps[39] = OpCodes.Jmp;
        oneByteOps[40] = OpCodes.Call;
        oneByteOps[41] = OpCodes.Calli;
        oneByteOps[42] = OpCodes.Ret;
        oneByteOps[43] = OpCodes.Br_S;
        oneByteOps[44] = OpCodes.Brfalse_S;
        oneByteOps[45] = OpCodes.Brtrue_S;
        oneByteOps[46] = OpCodes.Beq_S;
        oneByteOps[47] = OpCodes.Bge_S;
        oneByteOps[48] = OpCodes.Bgt_S;
        oneByteOps[49] = OpCodes.Ble_S;
        oneByteOps[50] = OpCodes.Blt_S;
        oneByteOps[51] = OpCodes.Bne_Un_S;
        oneByteOps[52] = OpCodes.Bge_Un_S;
        oneByteOps[53] = OpCodes.Bgt_Un_S;
        oneByteOps[54] = OpCodes.Ble_Un_S;
        oneByteOps[55] = OpCodes.Blt_Un_S;
        oneByteOps[56] = OpCodes.Br;
        oneByteOps[57] = OpCodes.Brfalse;
        oneByteOps[58] = OpCodes.Brtrue;
        oneByteOps[59] = OpCodes.Beq;
        oneByteOps[60] = OpCodes.Bge;
        oneByteOps[61] = OpCodes.Bgt;
        oneByteOps[62] = OpCodes.Ble;
        oneByteOps[63] = OpCodes.Blt;
        oneByteOps[64] = OpCodes.Bne_Un;
        oneByteOps[65] = OpCodes.Bge_Un;
        oneByteOps[66] = OpCodes.Bgt_Un;
        oneByteOps[67] = OpCodes.Ble_Un;
        oneByteOps[68] = OpCodes.Blt_Un;
        oneByteOps[69] = OpCodes.Switch;
        oneByteOps[70] = OpCodes.Ldind_I1;
        oneByteOps[71] = OpCodes.Ldind_U1;
        oneByteOps[72] = OpCodes.Ldind_I2;
        oneByteOps[73] = OpCodes.Ldind_U2;
        oneByteOps[74] = OpCodes.Ldind_I4;
        oneByteOps[75] = OpCodes.Ldind_U4;
        oneByteOps[76] = OpCodes.Ldind_I8;
        oneByteOps[77] = OpCodes.Ldind_I;
        oneByteOps[78] = OpCodes.Ldind_R4;
        oneByteOps[79] = OpCodes.Ldind_R8;
        oneByteOps[80] = OpCodes.Ldind_Ref;
        oneByteOps[81] = OpCodes.Stind_Ref;
        oneByteOps[82] = OpCodes.Stind_I1;
        oneByteOps[83] = OpCodes.Stind_I2;
        oneByteOps[84] = OpCodes.Stind_I4;
        oneByteOps[85] = OpCodes.Stind_I8;
        oneByteOps[86] = OpCodes.Stind_R4;
        oneByteOps[87] = OpCodes.Stind_R8;
        oneByteOps[88] = OpCodes.Add;
        oneByteOps[89] = OpCodes.Sub;
        oneByteOps[90] = OpCodes.Mul;
        oneByteOps[91] = OpCodes.Div;
        oneByteOps[92] = OpCodes.Div_Un;
        oneByteOps[93] = OpCodes.Rem;
        oneByteOps[94] = OpCodes.Rem_Un;
        oneByteOps[95] = OpCodes.And;
        oneByteOps[96] = OpCodes.Or;
        oneByteOps[97] = OpCodes.Xor;
        oneByteOps[98] = OpCodes.Shl;
        oneByteOps[99] = OpCodes.Shr;
        oneByteOps[100] = OpCodes.Shr_Un;
        oneByteOps[101] = OpCodes.Neg;
        oneByteOps[102] = OpCodes.Not;
        oneByteOps[103] = OpCodes.Conv_I1;
        oneByteOps[104] = OpCodes.Conv_I2;
        oneByteOps[105] = OpCodes.Conv_I4;
        oneByteOps[106] = OpCodes.Conv_I8;
        oneByteOps[107] = OpCodes.Conv_R4;
        oneByteOps[108] = OpCodes.Conv_R8;
        oneByteOps[109] = OpCodes.Conv_U4;
        oneByteOps[110] = OpCodes.Conv_U8;
        oneByteOps[111] = OpCodes.Callvirt;
        oneByteOps[112] = OpCodes.Cpobj;
        oneByteOps[113] = OpCodes.Ldobj;
        oneByteOps[114] = OpCodes.Ldstr;
        oneByteOps[115] = OpCodes.Newobj;
        oneByteOps[116] = OpCodes.Castclass;
        oneByteOps[117] = OpCodes.Isinst;
        oneByteOps[118] = OpCodes.Conv_R_Un;
        oneByteOps[121] = OpCodes.Unbox;
        oneByteOps[122] = OpCodes.Throw;
        oneByteOps[123] = OpCodes.Ldfld;
        oneByteOps[124] = OpCodes.Ldflda;
        oneByteOps[125] = OpCodes.Stfld;
        oneByteOps[126] = OpCodes.Ldsfld;
        oneByteOps[127] = OpCodes.Ldsflda;
        oneByteOps[128] = OpCodes.Stsfld;
        oneByteOps[129] = OpCodes.Stobj;
        oneByteOps[130] = OpCodes.Conv_Ovf_I1_Un;
        oneByteOps[131] = OpCodes.Conv_Ovf_I2_Un;
        oneByteOps[132] = OpCodes.Conv_Ovf_I4_Un;
        oneByteOps[133] = OpCodes.Conv_Ovf_I8_Un;
        oneByteOps[134] = OpCodes.Conv_Ovf_U1_Un;
        oneByteOps[135] = OpCodes.Conv_Ovf_U2_Un;
        oneByteOps[136] = OpCodes.Conv_Ovf_U4_Un;
        oneByteOps[137] = OpCodes.Conv_Ovf_U8_Un;
        oneByteOps[138] = OpCodes.Conv_Ovf_I_Un;
        oneByteOps[139] = OpCodes.Conv_Ovf_U_Un;
        oneByteOps[140] = OpCodes.Box;
        oneByteOps[141] = OpCodes.Newarr;
        oneByteOps[142] = OpCodes.Ldlen;
        oneByteOps[143] = OpCodes.Ldelema;
        oneByteOps[144] = OpCodes.Ldelem_I1;
        oneByteOps[145] = OpCodes.Ldelem_U1;
        oneByteOps[146] = OpCodes.Ldelem_I2;
        oneByteOps[147] = OpCodes.Ldelem_U2;
        oneByteOps[148] = OpCodes.Ldelem_I4;
        oneByteOps[149] = OpCodes.Ldelem_U4;
        oneByteOps[150] = OpCodes.Ldelem_I8;
        oneByteOps[151] = OpCodes.Ldelem_I;
        oneByteOps[152] = OpCodes.Ldelem_R4;
        oneByteOps[153] = OpCodes.Ldelem_R8;
        oneByteOps[154] = OpCodes.Ldelem_Ref;
        oneByteOps[155] = OpCodes.Stelem_I;
        oneByteOps[156] = OpCodes.Stelem_I1;
        oneByteOps[157] = OpCodes.Stelem_I2;
        oneByteOps[158] = OpCodes.Stelem_I4;
        oneByteOps[159] = OpCodes.Stelem_I8;
        oneByteOps[160] = OpCodes.Stelem_R4;
        oneByteOps[161] = OpCodes.Stelem_R8;
        oneByteOps[162] = OpCodes.Stelem_Ref;
        oneByteOps[163] = OpCodes.Ldelem;
        oneByteOps[164] = OpCodes.Stelem;
        oneByteOps[165] = OpCodes.Unbox_Any;
        oneByteOps[179] = OpCodes.Conv_Ovf_I1;
        oneByteOps[180] = OpCodes.Conv_Ovf_U1;
        oneByteOps[181] = OpCodes.Conv_Ovf_I2;
        oneByteOps[182] = OpCodes.Conv_Ovf_U2;
        oneByteOps[183] = OpCodes.Conv_Ovf_I4;
        oneByteOps[184] = OpCodes.Conv_Ovf_U4;
        oneByteOps[185] = OpCodes.Conv_Ovf_I8;
        oneByteOps[186] = OpCodes.Conv_Ovf_U8;
        oneByteOps[194] = OpCodes.Refanyval;
        oneByteOps[195] = OpCodes.Ckfinite;
        oneByteOps[198] = OpCodes.Mkrefany;
        oneByteOps[208] = OpCodes.Ldtoken;
        oneByteOps[209] = OpCodes.Conv_U2;
        oneByteOps[210] = OpCodes.Conv_U1;
        oneByteOps[211] = OpCodes.Conv_I;
        oneByteOps[212] = OpCodes.Conv_Ovf_I;
        oneByteOps[213] = OpCodes.Conv_Ovf_U;
        oneByteOps[214] = OpCodes.Add_Ovf;
        oneByteOps[215] = OpCodes.Add_Ovf_Un;
        oneByteOps[216] = OpCodes.Mul_Ovf;
        oneByteOps[217] = OpCodes.Mul_Ovf_Un;
        oneByteOps[218] = OpCodes.Sub_Ovf;
        oneByteOps[219] = OpCodes.Sub_Ovf_Un;
        oneByteOps[220] = OpCodes.Endfinally;
        oneByteOps[221] = OpCodes.Leave;
        oneByteOps[222] = OpCodes.Leave_S;
        oneByteOps[223] = OpCodes.Stind_I;
        oneByteOps[224] = OpCodes.Conv_U;
        oneByteOps[248] = OpCodes.Prefix7;
        oneByteOps[249] = OpCodes.Prefix6;
        oneByteOps[250] = OpCodes.Prefix5;
        oneByteOps[251] = OpCodes.Prefix4;
        oneByteOps[252] = OpCodes.Prefix3;
        oneByteOps[253] = OpCodes.Prefix2;
        oneByteOps[254] = OpCodes.Prefix1;
        oneByteOps[255] = OpCodes.Prefixref;
        twoByteOps[0] = OpCodes.Arglist;
        twoByteOps[1] = OpCodes.Ceq;
        twoByteOps[2] = OpCodes.Cgt;
        twoByteOps[3] = OpCodes.Cgt_Un;
        twoByteOps[4] = OpCodes.Clt;
        twoByteOps[5] = OpCodes.Clt_Un;
        twoByteOps[6] = OpCodes.Ldftn;
        twoByteOps[7] = OpCodes.Ldvirtftn;
        twoByteOps[9] = OpCodes.Ldarg;
        twoByteOps[10] = OpCodes.Ldarga;
        twoByteOps[11] = OpCodes.Starg;
        twoByteOps[12] = OpCodes.Ldloc;
        twoByteOps[13] = OpCodes.Ldloca;
        twoByteOps[14] = OpCodes.Stloc;
        twoByteOps[15] = OpCodes.Localloc;
        twoByteOps[17] = OpCodes.Endfilter;
        twoByteOps[18] = OpCodes.Unaligned;
        twoByteOps[19] = OpCodes.Volatile;
        twoByteOps[20] = OpCodes.Tailcall;
        twoByteOps[21] = OpCodes.Initobj;
        twoByteOps[22] = OpCodes.Constrained;
        twoByteOps[23] = OpCodes.Cpblk;
        twoByteOps[24] = OpCodes.Initblk;
        twoByteOps[26] = OpCodes.Rethrow;
        twoByteOps[28] = OpCodes.Sizeof;
        twoByteOps[29] = OpCodes.Refanytype;
        twoByteOps[30] = OpCodes.Readonly;
    }
    
    public static OpCode ParseOpCode(byte[] raw, ref int pos) {
        byte v = raw[pos++];
        return v == 0xFE ? twoByteOps[raw[pos++]] : oneByteOps[v];
    }
}

public enum IlOpCodeValues : ushort {
    Nop = 0x00,
    Break = 0x01,
    Ldarg_0 = 0x02,
    Ldarg_1 = 0x03,
    Ldarg_2 = 0x04,
    Ldarg_3 = 0x05,
    Ldloc_0 = 0x06,
    Ldloc_1 = 0x07,
    Ldloc_2 = 0x08,
    Ldloc_3 = 0x09,
    Stloc_0 = 0x0a,
    Stloc_1 = 0x0b,
    Stloc_2 = 0x0c,
    Stloc_3 = 0x0d,
    Ldarg_S = 0x0e,
    Ldarga_S = 0x0f,
    Starg_S = 0x10,
    Ldloc_S = 0x11,
    Ldloca_S = 0x12,
    Stloc_S = 0x13,
    Ldnull = 0x14,
    Ldc_I4_M1 = 0x15,
    Ldc_I4_0 = 0x16,
    Ldc_I4_1 = 0x17,
    Ldc_I4_2 = 0x18,
    Ldc_I4_3 = 0x19,
    Ldc_I4_4 = 0x1a,
    Ldc_I4_5 = 0x1b,
    Ldc_I4_6 = 0x1c,
    Ldc_I4_7 = 0x1d,
    Ldc_I4_8 = 0x1e,
    Ldc_I4_S = 0x1f,
    Ldc_I4 = 0x20,
    Ldc_I8 = 0x21,
    Ldc_R4 = 0x22,
    Ldc_R8 = 0x23,
    Dup = 0x25,
    Pop = 0x26,
    Jmp = 0x27,
    Call = 0x28,
    Calli = 0x29,
    Ret = 0x2a,
    Br_S = 0x2b,
    Brfalse_S = 0x2c,
    Brtrue_S = 0x2d,
    Beq_S = 0x2e,
    Bge_S = 0x2f,
    Bgt_S = 0x30,
    Ble_S = 0x31,
    Blt_S = 0x32,
    Bne_Un_S = 0x33,
    Bge_Un_S = 0x34,
    Bgt_Un_S = 0x35,
    Ble_Un_S = 0x36,
    Blt_Un_S = 0x37,
    Br = 0x38,
    Brfalse = 0x39,
    Brtrue = 0x3a,
    Beq = 0x3b,
    Bge = 0x3c,
    Bgt = 0x3d,
    Ble = 0x3e,
    Blt = 0x3f,
    Bne_Un = 0x40,
    Bge_Un = 0x41,
    Bgt_Un = 0x42,
    Ble_Un = 0x43,
    Blt_Un = 0x44,
    Switch = 0x45,
    Ldind_I1 = 0x46,
    Ldind_U1 = 0x47,
    Ldind_I2 = 0x48,
    Ldind_U2 = 0x49,
    Ldind_I4 = 0x4a,
    Ldind_U4 = 0x4b,
    Ldind_I8 = 0x4c,
    Ldind_I = 0x4d,
    Ldind_R4 = 0x4e,
    Ldind_R8 = 0x4f,
    Ldind_Ref = 0x50,
    Stind_Ref = 0x51,
    Stind_I1 = 0x52,
    Stind_I2 = 0x53,
    Stind_I4 = 0x54,
    Stind_I8 = 0x55,
    Stind_R4 = 0x56,
    Stind_R8 = 0x57,
    Add = 0x58,
    Sub = 0x59,
    Mul = 0x5a,
    Div = 0x5b,
    Div_Un = 0x5c,
    Rem = 0x5d,
    Rem_Un = 0x5e,
    And = 0x5f,
    Or = 0x60,
    Xor = 0x61,
    Shl = 0x62,
    Shr = 0x63,
    Shr_Un = 0x64,
    Neg = 0x65,
    Not = 0x66,
    Conv_I1 = 0x67,
    Conv_I2 = 0x68,
    Conv_I4 = 0x69,
    Conv_I8 = 0x6a,
    Conv_R4 = 0x6b,
    Conv_R8 = 0x6c,
    Conv_U4 = 0x6d,
    Conv_U8 = 0x6e,
    Callvirt = 0x6f,
    Cpobj = 0x70,
    Ldobj = 0x71,
    Ldstr = 0x72,
    Newobj = 0x73,
    Castclass = 0x74,
    Isinst = 0x75,
    Conv_R_Un = 0x76,
    Unbox = 0x79,
    Throw = 0x7a,
    Ldfld = 0x7b,
    Ldflda = 0x7c,
    Stfld = 0x7d,
    Ldsfld = 0x7e,
    Ldsflda = 0x7f,
    Stsfld = 0x80,
    Stobj = 0x81,
    Conv_Ovf_I1_Un = 0x82,
    Conv_Ovf_I2_Un = 0x83,
    Conv_Ovf_I4_Un = 0x84,
    Conv_Ovf_I8_Un = 0x85,
    Conv_Ovf_U1_Un = 0x86,
    Conv_Ovf_U2_Un = 0x87,
    Conv_Ovf_U4_Un = 0x88,
    Conv_Ovf_U8_Un = 0x89,
    Conv_Ovf_I_Un = 0x8a,
    Conv_Ovf_U_Un = 0x8b,
    Box = 0x8c,
    Newarr = 0x8d,
    Ldlen = 0x8e,
    Ldelema = 0x8f,
    Ldelem_I1 = 0x90,
    Ldelem_U1 = 0x91,
    Ldelem_I2 = 0x92,
    Ldelem_U2 = 0x93,
    Ldelem_I4 = 0x94,
    Ldelem_U4 = 0x95,
    Ldelem_I8 = 0x96,
    Ldelem_I = 0x97,
    Ldelem_R4 = 0x98,
    Ldelem_R8 = 0x99,
    Ldelem_Ref = 0x9a,
    Stelem_I = 0x9b,
    Stelem_I1 = 0x9c,
    Stelem_I2 = 0x9d,
    Stelem_I4 = 0x9e,
    Stelem_I8 = 0x9f,
    Stelem_R4 = 0xa0,
    Stelem_R8 = 0xa1,
    Stelem_Ref = 0xa2,
    Ldelem = 0xa3,
    Stelem = 0xa4,
    Unbox_Any = 0xa5,
    Conv_Ovf_I1 = 0xb3,
    Conv_Ovf_U1 = 0xb4,
    Conv_Ovf_I2 = 0xb5,
    Conv_Ovf_U2 = 0xb6,
    Conv_Ovf_I4 = 0xb7,
    Conv_Ovf_U4 = 0xb8,
    Conv_Ovf_I8 = 0xb9,
    Conv_Ovf_U8 = 0xba,
    Refanyval = 0xc2,
    Ckfinite = 0xc3,
    Mkrefany = 0xc6,
    Ldtoken = 0xd0,
    Conv_U2 = 0xd1,
    Conv_U1 = 0xd2,
    Conv_I = 0xd3,
    Conv_Ovf_I = 0xd4,
    Conv_Ovf_U = 0xd5,
    Add_Ovf = 0xd6,
    Add_Ovf_Un = 0xd7,
    Mul_Ovf = 0xd8,
    Mul_Ovf_Un = 0xd9,
    Sub_Ovf = 0xda,
    Sub_Ovf_Un = 0xdb,
    Endfinally = 0xdc,
    Leave = 0xdd,
    Leave_S = 0xde,
    Stind_I = 0xdf,
    Conv_U = 0xe0,
    Prefix7 = 0xf8,
    Prefix6 = 0xf9,
    Prefix5 = 0xfa,
    Prefix4 = 0xfb,
    Prefix3 = 0xfc,
    Prefix2 = 0xfd,
    Prefix1 = 0xfe,
    Prefixref = 0xff,
    Arglist = 0xfe00,
    Ceq = 0xfe01,
    Cgt = 0xfe02,
    Cgt_Un = 0xfe03,
    Clt = 0xfe04,
    Clt_Un = 0xfe05,
    Ldftn = 0xfe06,
    Ldvirtftn = 0xfe07,
    Ldarg = 0xfe09,
    Ldarga = 0xfe0a,
    Starg = 0xfe0b,
    Ldloc = 0xfe0c,
    Ldloca = 0xfe0d,
    Stloc = 0xfe0e,
    Localloc = 0xfe0f,
    Endfilter = 0xfe11,
    Unaligned_ = 0xfe12,
    Volatile_ = 0xfe13,
    Tail_ = 0xfe14,
    Initobj = 0xfe15,
    Constrained_ = 0xfe16,
    Cpblk = 0xfe17,
    Initblk = 0xfe18,
    Rethrow = 0xfe1a,
    Sizeof = 0xfe1c,
    Refanytype = 0xfe1d,
    Readonly_ = 0xfe1e,
}